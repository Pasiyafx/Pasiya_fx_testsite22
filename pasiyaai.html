<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pasiya AI Assistant</title>
  <style>
    :root{
      --bg:#f8f9fb;           /* light background */
      --panel:#ffffff;        /* white panels */
      --muted:#eef1f6;        /* soft gray */
      --text:#121418;         /* dark text */
      --sub:#5c667a;          /* subtle gray */
      --bubble-user:#eef1f6;  /* user bubble */
      --bubble-ai:#ffffff;    /* ai bubble */
      --shadow:0 6px 18px rgba(0,0,0,.08);
      --border:#dddddd;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      min-height:100vh; display:grid; grid-template-rows:auto 1fr; overflow:hidden;
    }
    header{background:#fff; border-bottom:1px solid var(--border)}
    .bar{display:flex; align-items:center; gap:.75rem; padding:.6rem .9rem}
    .logo{font-weight:800; color:#333}
    .pill{border:1px solid var(--border); background:#fff; padding:.45rem .7rem; border-radius:999px; box-shadow:var(--shadow); cursor:pointer}

    main{
      display:grid; grid-template-columns: minmax(0,1.6fr) 320px;
      height: calc(100vh - 64px); padding:.9rem; gap:.9rem;
    }
    .card{
      background:var(--panel); border:1px solid var(--border);
      border-radius:18px; box-shadow:var(--shadow); display:flex; flex-direction:column; min-height:0;
    }
    .card h3{margin:0; padding:.9rem; font-size:.95rem; color:var(--sub); font-weight:700}
    .messages{padding:1rem; overflow:auto; display:flex; flex-direction:column; gap:.9rem}
    .msg{display:flex; gap:.6rem; align-items:flex-start}
    .msg.user{flex-direction:row-reverse}
    .avatar{width:28px; height:28px; border-radius:50%; background:#cfcfcf}
    .bubble{max-width:80%; padding:.75rem .9rem; border-radius:16px; border:1px solid var(--border); box-shadow:var(--shadow)}
    .msg.user .bubble{background:var(--bubble-user)}
    .msg.ai .bubble{background:var(--bubble-ai)}

    .composer{display:flex; gap:.6rem; padding:.9rem; border-top:1px solid var(--border); background:#fafafa}
    .composer textarea{flex:1; resize:none; background:var(--muted); color:var(--text); border:1px solid var(--border); padding:.7rem .8rem; border-radius:12px; height:56px}
    .composer button{border:none; border-radius:12px; padding:.6rem .95rem; background:#1f6feb; color:#fff; cursor:pointer}

    /* Access Key modal */
    dialog#keyModal{
      border:none; border-radius:14px; padding:0; background:#fff; color:#111;
      box-shadow:0 12px 32px rgba(0,0,0,.18); width:min(520px,92vw)
    }
    dialog#keyModal form{display:grid; gap:0}
    dialog#keyModal header{padding:1rem; border-bottom:1px solid var(--border); font-weight:700}
    dialog#keyModal .body{padding:1rem}
    dialog#keyModal .row{display:flex; gap:.6rem; justify-content:flex-end; padding:.9rem; border-top:1px solid #eee}
    dialog#keyModal input{width:100%; padding:.6rem .7rem; border:1px solid #d0d6df; border-radius:10px; background:#f6f8fb; color:#111}

    /* Power-on overlay (red robot) */
    .power{position:fixed; inset:0; background:rgba(255,255,255,.92); display:grid; place-items:center; z-index:1000; opacity:0; transition:opacity .4s ease}
    .power.show{opacity:1}
    .power.hide{opacity:0; pointer-events:none}
    .power .robot{width:220px}
    .power .badge{margin-top:1rem; font-weight:800; color:#b00000}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">Pasiya AI <span>Assistant</span></div>
      <button id="accessKeyBtn" class="pill" style="margin-left:auto">Access Key</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h3>Chat</h3>
      <div id="messages" class="messages"></div>
      <form id="composer" class="composer">
        <textarea id="input" placeholder="Type a message‚Ä¶ / ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±‚Ä¶"></textarea>
        <button id="sendBtn" type="submit">Send</button>
      </form>
    </section>
    <aside class="card">
      <h3>Status</h3>
      <div id="statusBox" style="padding:1rem">‚ùå Not powered</div>
    </aside>
  </main>

  <!-- Access Key Modal -->
  <dialog id="keyModal">
    <form method="dialog">
      <header>Access Key</header>
      <div class="body">
        <label>OpenAI Access Key
          <input id="openaiKeyInput" type="password" placeholder="sk-..." />
        </label>
        <small style="display:block;color:#606f85;margin-top:.4rem">Saved locally in this browser.</small>
      </div>
      <div class="row">
        <button value="cancel">Cancel</button>
        <button id="saveAccessKey" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    // ---------- Helpers ----------
    const log = document.getElementById('messages');
    const form = document.getElementById('composer');
    const input = document.getElementById('input');
    const statusBox = document.getElementById('statusBox');

    function esc(s){ return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function add(role,text){
      const row = document.createElement('div');
      row.className = 'msg '+role;
      row.innerHTML = `<div class="avatar"></div><div class="bubble">${esc(text).replace(/\n/g,'<br>')}</div>`;
      log.appendChild(row); log.scrollTop = log.scrollHeight;
    }

    // ---------- Access Key Modal ----------
    const keyBtn  = document.getElementById('accessKeyBtn');
    const keyDlg  = document.getElementById('keyModal');
    const keyInput= document.getElementById('openaiKeyInput');
    const keySave = document.getElementById('saveAccessKey');

    keyBtn.addEventListener('click', ()=>{
      keyInput.value = localStorage.getItem('openai_key') || '';
      keyDlg.showModal();
    });

    keySave.addEventListener('click', ()=>{
      const v = keyInput.value.trim();
      if(v){ localStorage.setItem('openai_key', v); }
      keyDlg.close();
      powerOnSequence();
      refreshPowerStatus();
    });

    function refreshPowerStatus(){
      const hasKey = !!localStorage.getItem('openai_key');
      statusBox.textContent = hasKey ? '‚úÖ Pasiya AI ready' : '‚ùå Not powered';
    }

    // ---------- Power-on overlay (red robot) ----------
    function powerOnSequence(){
      const overlay = document.createElement('div');
      overlay.className = 'power show';
      overlay.innerHTML = `
        <div style="text-align:center">
          <svg class="robot" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" aria-label="Robot Red">
            <rect x="50" y="40" width="100" height="70" rx="14" fill="#ff3b3b" stroke="#d21f1f"/>
            <circle cx="100" cy="25" r="6" fill="#d21f1f">
              <animate attributeName="r" values="6;9;6" dur="1.2s" repeatCount="3"/>
            </circle>
            <rect x="70" y="65" width="20" height="12" rx="4" fill="#7a0a0a"/>
            <rect x="110" y="65" width="20" height="12" rx="4" fill="#7a0a0a"/>
            <rect x="85" y="85" width="30" height="6" rx="3" fill="#7a0a0a"/>
            <rect x="60" y="110" width="80" height="60" rx="12" fill="#ff5b5b" stroke="#d21f1f"/>
          </svg>
          <div class="badge">Pasiya AI ‚Äî Power on</div>
        </div>`;
      document.body.appendChild(overlay);
      setTimeout(()=>{ overlay.classList.add('hide');
        setTimeout(()=>{ overlay.remove(); add('ai','‚ö° Pasiya AI ‚Äî Power on'); }, 450);
      }, 1200);
    }

    // ---------- OpenAI Chat Integration ----------
    async function callOpenAI(userText){
      const key = localStorage.getItem('openai_key');
      if(!key){ add('ai','‚ùå No Access Key set. Click ‚ÄúAccess Key‚Äù and paste your sk-...'); return; }

      // temp ‚ÄúThinking‚Ä¶‚Äù bubble
      const temp = document.createElement('div');
      temp.className='msg ai';
      temp.innerHTML = '<div class="avatar"></div><div class="bubble">Thinking‚Ä¶</div>';
      log.appendChild(temp); log.scrollTop = log.scrollHeight;

      try{
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
          body: JSON.stringify({
            model: 'gpt-4o-mini',   // use a chat-capable model available to your key
            messages: [
              { role:'system', content:'You are a helpful, concise bilingual assistant (Sinhala/English). Reply in the language the user uses.' },
              { role:'user', content: userText }
            ],
            temperature: 0.7
          })
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error(t || ('HTTP '+res.status));
        }
        const data = await res.json();
        const out = (data.choices?.[0]?.message?.content || '').trim() || '(no response)';
        temp.remove();
        add('ai', out);
      }catch(err){
        temp.remove();
        add('ai', '‚ö†Ô∏è API error: ' + (err?.message || err));
      }
    }

    // ---------- Chat form ----------
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const v = input.value.trim();
      if(!v) return;
      input.value = '';
      add('user', v);
      callOpenAI(v);
    });

    // ---------- Boot ----------
    (function boot(){
      refreshPowerStatus();
      add('ai','üëã Assistant area is open. Type anything! (/ Sinhala or English)');
    })();
  </script>
</body>
</html>
